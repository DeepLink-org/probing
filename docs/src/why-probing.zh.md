# ä¸ºä»€ä¹ˆé€‰æ‹© Probingï¼Ÿ

Probing æ˜¯ä¸€ä¸ªä¸“ä¸º AI åº”ç”¨è®¾è®¡çš„åŠ¨æ€æ€§èƒ½åˆ†æå·¥å…·ã€‚æœ¬æ–‡è¯¦ç»†ä»‹ç» Probing çš„æ ¸å¿ƒæŠ€æœ¯ä¼˜åŠ¿å’Œè®¾è®¡ç†å¿µã€‚

## è®¾è®¡ç†å¿µ

### é›¶ä¾µå…¥åŸåˆ™

ä¼ ç»Ÿçš„æ€§èƒ½åˆ†æå·¥å…·é€šå¸¸éœ€è¦ä¿®æ”¹ä»£ç ï¼š

```python
# âŒ ä¼ ç»Ÿæ–¹å¼ï¼šéœ€è¦ä¿®æ”¹ä»£ç 
import logging
import time

def train_step(model, data):
    start = time.time()
    logging.info("Starting train step")

    loss = model(data)

    logging.info(f"Train step took {time.time() - start:.3f}s")
    return loss
```

Probing çš„æ–¹å¼å®Œå…¨ä¸åŒï¼š

```bash
# âœ… Probing æ–¹å¼ï¼šé›¶ä»£ç ä¿®æ”¹
probing -t <pid> inject
probing -t <pid> query "SELECT * FROM python.torch_trace"
```

### SQL é©±åŠ¨åˆ†æ

ä¸ºä»€ä¹ˆé€‰æ‹© SQL è€Œä¸æ˜¯å›ºå®šæŠ¥å‘Šï¼Ÿ

| ä¼ ç»ŸæŠ¥å‘Š | SQL æŸ¥è¯¢ |
|----------|----------|
| é¢„è®¾çš„å›ºå®šæ ¼å¼ | çµæ´»çš„è‡ªå®šä¹‰æŸ¥è¯¢ |
| éœ€è¦å¯¼å‡ºåå¤„ç† | å®æ—¶äº¤äº’åˆ†æ |
| éš¾ä»¥æ·±å…¥é’»å– | ä»»æ„ç»´åº¦èšåˆ |
| å­¦ä¹ ä¸“æœ‰è¯­æ³• | é€šç”¨ SQL æŠ€èƒ½ |

```sql
-- ç¤ºä¾‹ï¼šæ‰¾å‡ºæœ€è€—æ—¶çš„ 10 ä¸ªæ“ä½œ
SELECT
    operation_name,
    AVG(duration_ms) as avg_duration,
    COUNT(*) as call_count
FROM python.torch_trace
WHERE timestamp > now() - interval '5 minutes'
GROUP BY operation_name
ORDER BY avg_duration DESC
LIMIT 10
```

## æ ¸å¿ƒæŠ€æœ¯ä¼˜åŠ¿

### 1. åŠ¨æ€æ¢é’ˆæ³¨å…¥

#### æŠ€æœ¯å®ç°

Probing ä½¿ç”¨ Linux ptrace ç³»ç»Ÿè°ƒç”¨å®ç°ä»£ç æ³¨å…¥ï¼š

```
ç›®æ ‡è¿›ç¨‹                          Probing CLI
    â”‚                                  â”‚
    â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    1. ptrace attach    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Running â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Tracer  â”‚
â”‚ Process â”‚                        â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                  â”‚
    â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    2. æ³¨å…¥ shellcode   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Paused  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Inject  â”‚
â”‚         â”‚                        â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                  â”‚
    â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    3. è°ƒç”¨ dlopen      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Execute â”‚
â”‚ Library â”‚                        â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                  â”‚
    â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    4. æ¢å¤æ‰§è¡Œ         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Resume  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Detach  â”‚
â”‚ + Probe â”‚                        â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®‰å…¨ä¿è¯

- **çŠ¶æ€å®Œæ•´ä¿å­˜**ï¼šæ³¨å…¥å‰ä¿å­˜æ‰€æœ‰å¯„å­˜å™¨å’Œè¢«è¦†ç›–çš„å†…å­˜
- **åŸå­æ€§æ“ä½œ**ï¼šæ³¨å…¥å¤±è´¥æ—¶å®Œå…¨å›æ»š
- **æƒé™æ£€æŸ¥**ï¼šä»…å…è®¸è¿›ç¨‹æ‰€æœ‰è€…æ³¨å…¥
- **å†…å­˜å¯¹é½**ï¼šç¡®ä¿æ ˆæŒ‡é’ˆ 16 å­—èŠ‚å¯¹é½ï¼ˆx86-64 ABIï¼‰

### 2. åŸºäº DataFusion çš„æŸ¥è¯¢å¼•æ“

#### ä¸ºä»€ä¹ˆé€‰æ‹© DataFusionï¼Ÿ

| ç‰¹æ€§ | DataFusion | è‡ªç ”å¼•æ“ |
|------|------------|----------|
| å¼€å‘æˆæœ¬ | ä½ | é«˜ |
| SQL å…¼å®¹æ€§ | å®Œæ•´ | éƒ¨åˆ† |
| æ€§èƒ½ä¼˜åŒ– | æˆç†Ÿ | éœ€ç§¯ç´¯ |
| ç¤¾åŒºæ”¯æŒ | æ´»è·ƒ | æ—  |
| Arrow é›†æˆ | åŸç”Ÿ | éœ€é€‚é… |

#### æ’ä»¶æ¶æ„

```rust
/// æ’ä»¶ trait å®šä¹‰
pub trait Plugin {
    fn name(&self) -> String;
    fn kind(&self) -> PluginType;
    fn namespace(&self) -> String;
    fn register_table(&self, ...) -> Result<()>;
}
```

å†…ç½®æ’ä»¶ï¼š

- `python.backtrace` - Python è°ƒç”¨æ ˆ
- `python.torch_trace` - PyTorch æ“ä½œè¿½è¸ª
- `python.memory` - å†…å­˜ä½¿ç”¨ç»Ÿè®¡
- `system.process` - è¿›ç¨‹ä¿¡æ¯

### 3. è¿œç¨‹ REPL

#### å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLI REPL   â”‚  HTTP   â”‚ ç›®æ ‡è¿›ç¨‹      â”‚
â”‚              â”‚ â”€â”€â”€â”€â”€â–º â”‚              â”‚
â”‚ >>> expr     â”‚         â”‚  Python è§£é‡Šå™¨â”‚
â”‚              â”‚ â—„â”€â”€â”€â”€â”€ â”‚              â”‚
â”‚ result       â”‚  JSON   â”‚  æ‰§è¡Œ + è¿”å›  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä½¿ç”¨åœºæ™¯

```python
# è¿æ¥åˆ°è¿è¡Œä¸­çš„è¿›ç¨‹
probing -t <pid> repl

>>> # æ£€æŸ¥æ¨¡å‹å‚æ•°
>>> model = [m for m in gc.get_objects() if isinstance(m, torch.nn.Module)][0]
>>> print(sum(p.numel() for p in model.parameters()))
125000000

>>> # æ£€æŸ¥ GPU å†…å­˜
>>> print(torch.cuda.memory_allocated() / 1e9, "GB")
12.5 GB

>>> # æ£€æŸ¥å½“å‰ loss
>>> print(loss.item())
0.0234
```

### 4. Python å¤šç‰ˆæœ¬æ”¯æŒ

Probing æ”¯æŒ Python 3.4 åˆ° 3.13 çš„æ‰€æœ‰ç‰ˆæœ¬ï¼š

```
Python ç‰ˆæœ¬    â”‚  Frame ç»“æ„    â”‚  æ”¯æŒçŠ¶æ€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
3.4 - 3.10    â”‚  PyFrameObject â”‚    âœ…
3.11          â”‚  _PyCFrame     â”‚    âœ…
3.12          â”‚  _PyCFrame     â”‚    âœ…
3.13+         â”‚  current_frame â”‚    âœ…
```

è¿™é€šè¿‡é’ˆå¯¹æ¯ä¸ª Python ç‰ˆæœ¬çš„å†…éƒ¨ç»“æ„ bindings å®ç°ã€‚

## æ€§èƒ½ç‰¹å¾

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…æµ‹é‡ |
|------|--------|----------|
| CPU å¼€é”€ | < 5% | ~2-3% |
| å†…å­˜å¼€é”€ | < 50MB | ~30MB |
| æŸ¥è¯¢å»¶è¿Ÿ | < 10ms | ~5ms |
| æ³¨å…¥æ—¶é—´ | < 100ms | ~50ms |

## ä¸ç«å“çš„è¯¦ç»†å¯¹æ¯”

### vs py-spy

| ç»´åº¦ | Probing | py-spy |
|------|---------|--------|
| æ ¸å¿ƒåŠŸèƒ½ | å®Œæ•´åˆ†æå¹³å° | é‡‡æ · profiler |
| æ•°æ®æŸ¥è¯¢ | SQL | å›ºå®šæ ¼å¼ |
| ä»£ç æ‰§è¡Œ | REPL æ”¯æŒ | ä¸æ”¯æŒ |
| åˆ†å¸ƒå¼ | åŸç”Ÿæ”¯æŒ | ä¸æ”¯æŒ |
| é€‚ç”¨åœºæ™¯ | AI è®­ç»ƒè°ƒè¯• | é€šç”¨ Python |

### vs torch.profiler

| ç»´åº¦ | Probing | torch.profiler |
|------|---------|----------------|
| ä»£ç ä¾µå…¥ | æ—  | éœ€è¦ |
| è¿è¡Œæ—¶é™„åŠ  | æ”¯æŒ | ä¸æ”¯æŒ |
| æŸ¥è¯¢çµæ´»æ€§ | SQL | å›ºå®š API |
| é PyTorch æ”¯æŒ | æ”¯æŒ | ä¸æ”¯æŒ |

### vs Perfetto

| ç»´åº¦ | Probing | Perfetto |
|------|---------|----------|
| ä¾§é‡ç‚¹ | AI åº”ç”¨ | ç³»ç»Ÿè¿½è¸ª |
| éƒ¨ç½²å¤æ‚åº¦ | ä½ | é«˜ |
| Python é›†æˆ | åŸç”Ÿ | æœ‰é™ |
| å­¦ä¹ æ›²çº¿ | ä½ | é«˜ |

## æ€»ç»“

Probing çš„ç‹¬ç‰¹ä»·å€¼åœ¨äºå°†ä¸‰ä¸ªå¼ºå¤§èƒ½åŠ›æ•´åˆåœ¨ä¸€èµ·ï¼š

1. **åŠ¨æ€æ³¨å…¥** - æ— éœ€ä¿®æ”¹ä»£ç ï¼Œè¿è¡Œæ—¶é™„åŠ 
2. **SQL æŸ¥è¯¢** - çµæ´»çš„æ•°æ®åˆ†æèƒ½åŠ›
3. **è¿œç¨‹ REPL** - å®æ—¶äº¤äº’è°ƒè¯•

è¿™ç§ç»„åˆä½¿å¾— Probing ç‰¹åˆ«é€‚åˆï¼š

- ğŸ”¬ AI ç ”ç©¶äººå‘˜è°ƒè¯•è®­ç»ƒé—®é¢˜
- ğŸ› ï¸ æ¡†æ¶å¼€å‘è€…åˆ†ææ€§èƒ½ç“¶é¢ˆ
- ğŸ­ MLOps å·¥ç¨‹å¸ˆç›‘æ§ç”Ÿäº§ç¯å¢ƒ

[å¼€å§‹ä½¿ç”¨ Probing â†’](quickstart.zh.md)
